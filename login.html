{% extends "base.html" %}

{% block content %}
<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
    }
    
    .form-card {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 30px;
        width: 100%;
        max-width: 450px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    
    .form-header {
        text-align: center;
        margin-bottom: 25px;
    }
    
    .form-header h2 {
        color: white;
        font-size: 2rem;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: white;
        font-weight: bold;
    }
    
    .form-group input {
        width: 100%;
        padding: 12px 15px;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.9);
        font-size: 1rem;
    }
    
    .error {
        color: #ff6b6b;
        font-size: 0.9rem;
        margin-top: 5px;
        text-align: center;
        display: none;
    }
    
    .btn-submit {
        width: 100%;
        padding: 12px;
        background: #4e54c8;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .btn-submit:hover {
        background: #3f43a8;
    }
    
    .form-footer {
        text-align: center;
        margin-top: 20px;
        color: white;
    }
    
    .form-footer a {
        color: #4e54c8;
        text-decoration: none;
        font-weight: bold;
    }
    
    .form-footer a:hover {
        text-decoration: underline;
    }
    
    .captcha-container {
        display: flex;
        gap: 10px;
    }
    
    .captcha-container input {
        flex: 6;
    }
    
    .captcha-container button {
        flex: 4;
        padding: 12px;
        background: #6c5ce7;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .captcha-container button:disabled {
        background: #b2bec3;
        cursor: not-allowed;
    }
    
    #registerForm {
        display: none;
    }
    #forgetpasswordform{
        display: none;
    }

</style>

<div class="login-container">
    <div class="form-card">
        <!-- 登录表单 -->
        <form id="loginForm" method="POST" action="/tologin">
            <div class="form-header">
                <h2>登录</h2>
            </div>
            
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" name="username" placeholder="请输入用户名" required>

            </div>
            
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" name="password" placeholder="请输入密码" required>
                <p id="loginerror" class="error">账号密码错误</p>
            </div>

            <button type="submit" class="btn-submit">登录</button>
            <p><a href="#" id="toforgetpassword">忘记密码? </a></p>
            <div class="form-footer">
                <p>还没有账号? <a href="#" id="showRegister">立即注册</a></p>
            </div>
        </form>
        
        <!-- 注册表单 -->
        <form id="registerForm" method="POST" action="/toregister">
            <div class="form-header">
                <h2>注册</h2>
            </div>
            
            <div class="form-group">
                <label for="reg_username">用户名</label>
                <input type="text" id="reg_username" name="reg_username" placeholder="只支持字母 长度4-10" required>
                <div class="error" id="reg-username-error">error</div>
            </div>
            
            <div class="form-group">
                <label for="email">手机号/邮箱</label>
                <input type="email" id="email" name="email" placeholder="请输入有效的手机号或邮箱" required>
                <div class="error" id="email-error">error</div>
            </div>
            
            <div class="form-group">
                <label for="reg_password">密码</label>
                <input type="password" id="reg_password" name="password" placeholder="密码必须包含字母和数字" required>
                <div class="error" id="reg-password-error">error</div>
            </div>
            
            <div class="form-group">
                <label for="confirm_password">确认密码</label>
                <input type="password" id="confirm_password" name="confirm_password" placeholder="请确认密码" required>
                <div class="error" id="confirm-password-error">两次输入的密码不一致</div>
            </div>
            
            <div class="form-group">
                <label id="reg_captchatext" for="reg_captcha">验证码</label>
                <div class="captcha-container">
                    <input type="text" id="reg_captcha" name="reg_captcha" placeholder="请输入验证码" required>
                    <button type="button" id="sendCaptcha">发送验证码</button>
                </div>
                <div class="error" id="captcha-error">error</div>
            </div>
            
            <button type="submit" class="btn-submit">注册</button>

            <div class="form-footer">
                <p>已有账号? <a href="#" id="showLogin">立即登录</a></p>
                <p>注册代表您已同意<a href="#">用户协议</a>和<a href="#">隐私政策</a></p>
            </div>
        </form>
        <form id="forgetpassword" method="POST" action="/forgetpassaword">
        </form>
        <!-- 忘记表单-->
        <form id="forgetpasswordform" method="POST" action="/forgetpassword">
            <p><a href="#" id="returnlogin">《 返回</a></p>
            <div class="form-group">
                <label for="forgetusername">用户名</label>
                <input type="text" id="forgetusername" name="forgetusername" placeholder="请输入用户名" required>

            </div>

            <div class="form-group">
                <label for="nowpassword">新密码</label>
                <input type="password" id="nowpassword" name="nowpassword" placeholder="请输入新密码" required>
                <p id="erroe" class="error" >error</p>
            </div>

            <div class="form-group">
                <label for="nowpassword2">新密码</label>
                <input type="password" id="nowpassword2" name="nowpassword2" placeholder="请再次输入新密码" required>
                <p id="erroe" class="error" >error</p>
            </div>
            <div class="form-group">
                <label id="tosendforgetCaptcha" for="reg_captcha">验证码</label>
                <div class="captcha-container">
                    <input type="text" id="forgetcaptcha" name="forgetcaptcha" placeholder="请输入验证码" required>
                    <button type="button" id="sendforgetCaptcha">发送验证码</button>
                </div>
                <div class="error" id="forgetcaptcha-error">请输入验证码</div>
            </div>

            <button type="submit" class="btn-submit">确认</button>
        </form>



    </div>
</div>

<script>
    // 表单切换
    document.getElementById('showRegister').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
    });
    document.getElementById('showLogin').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
    });
    document.getElementById('toforgetpassword').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('forgetpasswordform').style.display = 'block';
    });
    document.getElementById('returnlogin').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('forgetpasswordform').style.display = 'none';
    });
    //登录提交
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const loginerror = document.getElementById('loginerror');
        const yzm = document.getElementById('yzm').innerHTML;

        if (username.length >= 6 && username.length <= 10 && password.length >= 6 && password.length <= 16) {
            fetch("/tologin", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    yzm: yzm
                })
            })
            .then(res => res.json())
            .then(res => {
                if (res.status === "success") {
                    console.log(res);
                    window.location.replace('home');
                }
                else {
                    loginerror.style.display = 'block';
                    loginerror.innerHTML = res.reson;
                    console.log(res);
                }
            })

        }
        else {
            loginerror.style.display = 'block';
            loginerror.innerHTML = "账号密码格式错误"

        }
    })
    //注册检测
    document.getElementById('sendCaptcha').addEventListener('click', function() {
        const username = document.getElementById('reg_username').value
        const phoneemail = document.getElementById('email').value
        const password1 = document.getElementById('reg_password').value
        const password2 = document.getElementById('confirm_password').value
        document.getElementById('reg-username-error').style.display = 'none';
        document.getElementById('email-error').style.display = 'none';
        document.getElementById('reg-password-error').style.display = 'none';
        document.getElementById('confirm-password-error').style.display = 'none';
        const u = /^[a-z]{4,10}$/
        if (u.test(username)) {
            const pe = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/
            const pe2 = /^1[3-9]\d{9}$/
            if (pe.test(phoneemail)){
                const  pa = /^(?=.*[a-zA-Z])(?=.*\d)[A-Za-z\d]{8,16}$/
                if (pa.test(password1)) {
                    if (password1 === password2) {

                        fetch("/seedcaptcha", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                username: username,
                                seedtype: "email",
                                phoneemail: phoneemail
                            })
                        })
                            .then(res => res.json())
                            .then(res => {
                                if (res.status === "success") {
                                    document.getElementById("reg_captchatext").innerHTML = "验证码 已发送到"+phoneemail;
                                    document.getElementById('reg_username').disabled = true;
                                    document.getElementById('reg_password').disabled = true;
                                    document.getElementById('email').disabled = true;
                                    document.getElementById('confirm_password').disabled = true;
                                    let countdown = 60;
                                    const button = document.getElementById('sendCaptcha');
                                    button.disabled = true;
                                    const timer = setInterval(() => {
                                        button.textContent = `重新发送(${countdown})`;
                                        countdown--;
                                        if (countdown < 0) {
                                            document.getElementById("reg_captchatext").innerHTML = "验证码";
                                            clearInterval(timer);
                                            button.disabled = false;
                                            document.getElementById('reg_username').disabled = false;
                                            document.getElementById('reg_password').disabled = false;
                                            document.getElementById('email').disabled = false;
                                            document.getElementById('confirm_password').disabled = false;
                                            button.textContent = '发送验证码';
                                        }
                                    }, 1000);

                                }
                                else {
                                    console.log(res);
                                }
                            })


                    } else {
                        document.getElementById('confirm-password-error').style.display = 'block';
                    }
                } else {
                    document.getElementById('reg-password-error').innerHTML = "请输入有效密码";
                    document.getElementById('reg-password-error').style.display = 'block';
                }
            } else if (pe2.test(phoneemail)) {
                alert("phone")
            } else {
                document.getElementById('email-error').innerHTML = "请输入有效邮箱或手机号";
                document.getElementById('email-error').style.display = 'block';
            }

        } else {
            document.getElementById('reg-username-error').innerHTML = "格式错误";
            document.getElementById('reg-username-error').style.display = 'block';
        }

    })

    //注册提交
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('reg_username').value
        const phoneemail = document.getElementById('email').value
        const password1 = document.getElementById('reg_password').value
        const password2 = document.getElementById('confirm_password').value
        const captcha = document.getElementById('reg_captcha').value
        document.getElementById('reg-username-error').style.display = 'none';
        document.getElementById('email-error').style.display = 'none';
        document.getElementById('reg-password-error').style.display = 'none';
        document.getElementById('confirm-password-error').style.display = 'none';
        const u = /^[a-z]{4,10}$/
        if (u.test(username)) {
            const pe = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/
            const pe2 = /^1[3-9]\d{9}$/
            if (pe.test(phoneemail)){
                const  pa = /^(?=.*[a-zA-Z])(?=.*\d)[A-Za-z\d]{8,16}$/
                if (pa.test(password1)) {
                    if (password1 === password2) {

                        fetch("/toregister", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                username: username,
                                phoneemail: phoneemail,
                                password1: password1,
                                password2: password2,
                                captcha: captcha
                            })
                        })
                            .then(res => res.json())
                            .then(res => {
                                if (res.status === "success") {
                                    alert("注册成功");
                                    window.location.replace("login");
                                } else {
                                    document.getElementById("captcha-error").innerHTML = res.message;
                                }
                            })


                    } else {
                        document.getElementById('confirm-password-error').style.display = 'block';
                    }
                } else {
                    document.getElementById('reg-password-error').innerHTML = "请输入有效密码";
                    document.getElementById('reg-password-error').style.display = 'block';
                }
            } else if (pe2.test(phoneemail)) {
                alert("phone")
            } else {
                document.getElementById('email-error').innerHTML = "请输入有效邮箱或手机号";
                document.getElementById('email-error').style.display = 'block';
            }

        } else {
            document.getElementById('reg-username-error').innerHTML = "格式错误";
            document.getElementById('reg-username-error').style.display = 'block';
        }

    })

    //忘记密码





</script>
{% endblock %}